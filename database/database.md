# Database Module

This module adds **SQLite support** to the project with a lightweight migration system.
It is designed so the CLI (MCP) can track metadata (projects, routes, pages, contexts, etc.) without requiring the consumer to repeat themselves.

---

## Structure

The database module is structured as follows:

```
src/
└── database/
    ├── migrations/
    │   └── <timestamp>-<migration-name>.ts
    ├── sql/
    │   └── <query-name>.sql
    └── index.ts
```

---

## Tables & Schemas

### `migration_status`

Tracks the possible statuses for a migration.

```sql
CREATE TABLE IF NOT EXISTS migration_status (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL UNIQUE -- 'pending', 'applied', 'failed', 'rolled_back'
);
```

### `migrations`

Tracks the migrations that have been applied to the database.

```sql
CREATE TABLE IF NOT EXISTS migrations (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    migration_name TEXT NOT NULL UNIQUE,
    applied_at DATETIME,
    rolled_back_at DATETIME,
    status TEXT NOT NULL CHECK(status IN('pending', 'applied', 'failed', 'rolled_back')),
    checksum TEXT,
    description TEXT
);

CREATE INDEX idx_migration_name ON migrations(migration_name);

CREATE INDEX idx_status ON migrations(status);
```

### `projects`

Stores app-level projects.

```sql
CREATE TABLE IF NOT EXISTS projects (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    description TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE UNIQUE INDEX idx_project_name ON projects(name);
```

### `features`

Tracks features linked to projects.

```sql
CREATE TABLE IF NOT EXISTS features (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    project_id INTEGER NOT NULL,
    name TEXT NOT NULL,
    description TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES projects(id)
);
```

### `routes`

Tracks routes generated by MCP.

```sql
  CREATE TABLE IF NOT EXISTS routes (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    project_id INTEGER NOT NULL,
    path TEXT NOT NULL,
    name TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES projects(id)
);

CREATE INDEX idx_project_id ON routes(project_id);
CREATE UNIQUE INDEX idx_route_path ON routes(path);
```

### `pages`

Tracks pages generated by MCP.

```sql
CREATE TABLE IF NOT EXISTS pages (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    route_id INTEGER NOT NULL,
    name TEXT NOT NULL,
    type TEXT, -- e.g., 'root', 'create', 'edit', 'list', 'view'
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (route_id) REFERENCES routes(id)
);

CREATE INDEX idx_route_id ON pages(route_id);
```

### `contexts`

Tracks React contexts.

```sql
CREATE TABLE IF NOT EXISTS contexts (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    project_id INTEGER NOT NULL,
    name TEXT NOT NULL,
    description TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES projects(id)
);

CREATE UNIQUE INDEX idx_context_name ON contexts(name);
```

### `components`

```sql
CREATE TABLE IF NOT EXISTS components (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    project_id INTEGER NOT NULL,
    name TEXT NOT NULL,
    type TEXT, -- e.g., 'UI', 'Form', 'Layout'
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES projects(id)
);

CREATE UNIQUE INDEX idx_component_name ON components(name);
```

### `logs`

Tracks CLI or DB events.

```sql
CREATE TABLE IF NOT EXISTS logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    event TEXT NOT NULL,
    level TEXT DEFAULT 'info', -- 'info', 'warn', 'error'
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### `migrations`

Migrations are written in real SQL files (.sql) and tracked in the migrations table to ensure they are executed only once.

#### `Creating a migration`

```sh
  npm run generate:migration <name>
```

Examples:

```sh
  npm run generate:migration create projects table
  npm run generate:migration add features table
```

This generates two timestamped .sql files under src/database/migrations/, e.g.:

```sh
  20230101120000_create_projects_table_up.sql
  20230101120000_create_projects_table_down.sql
```

## `Scripts`

#### `scripts/generate-migration.sh`

- Creates a new timestamped migration file.
- Supports multi-word names (spaces → \_).

#### `scripts/generate-sql.sh`

- Optional: scaffolds SQL template files.

## `Migration Runner (src/database/index.ts)`

- On startup, connects to SQLite.
- Ensures the migrations table exists.
- Executes any pending .sql migrations in order.
- Records executed migrations in the migrations table.

## `Usage`

### 1. Create a migration:

```sh
  npm run generate:migration <name>
```

### 2. Write your SQL inside the generated file:

```sql
-- up
CREATE TABLE projects (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  name TEXT NOT NULL,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- down
DROP TABLE projects;
```

### 3. Run your app / CLI

On startup, migrations will be applied automatically.
